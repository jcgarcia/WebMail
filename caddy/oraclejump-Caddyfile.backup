{
    storage file_system {
        root /var/lib/caddy
    }
    email admin@ingasti.com
    order authenticate before respond
    order authorize before respond

    security {
        # Local user database (fallback/admin accounts)
        local identity store localdb {
            realm local
            path /data/.local/caddy/users.json
        }

        # GitHub OAuth provider
        oauth identity provider github {
            realm github
            driver github
            client_id {env.GITHUB_CLIENT_ID}
            client_secret {env.GITHUB_CLIENT_SECRET}
            scopes user
        }

        # Authentication portal - GitHub-first
        authentication portal myportal {
            crypto key sign-verify {env.SHARED_TOKEN_KEY}
            crypto default token lifetime 3600
            enable identity provider github
            enable identity store localdb
            cookie domain .ingasti.com
            cookie lifetime 86400
            
            ui {
                logo url "https://auth.ingasti.com/assets/ingasti-logo-100.png"
                logo description "Ingasti"
                links {
                    "Code Server" "https://codeh.ingasti.com" icon "las la-code"
                    "Code (OCI)" "https://code.ingasti.com" icon "las la-laptop-code"
                    "Jenkins" "https://jenkins.ingasti.com" icon "las la-cogs"
                    "Control" "https://control.ingasti.com" icon "las la-tachometer-alt"
                    "Jump" "https://jump.ingasti.com" icon "las la-server"
                    "MailHub" "https://mailhub.ingasti.com" icon "las la-envelope"
                }
            }
            
            # Make jcgarcia admin
            transform user {
                match realm github
                match sub github.com/jcgarciax
                action add role authp/admin
            }
            
            # All GitHub users get basic access
            transform user {
                match realm github
                action add role authp/user
            }
            
            # Local users get basic access
            transform user {
                match origin local
                action add role authp/user
            }
        }

        # Authorization policy
        authorization policy mypolicy {
            crypto key verify {env.SHARED_TOKEN_KEY}
            set auth url https://auth.ingasti.com/auth
            allow roles authp/admin authp/user
            
            acl rule {
                comment allow admins and users
                match role authp/admin authp/user
                allow stop log info
            }
            acl rule {
                comment deny unauthenticated
                match any
                deny log warn
            }
        }
    }
}

:80 {
    redir https://{host}{uri} permanent
}

# Authentication Portal
auth.ingasti.com {
    # Static assets
    handle /assets/* {
        root * /usr/share/caddy
        file_server
    }
    
    # Custom portal for authenticated users
    handle /portal {
        authorize with mypolicy
        root * /usr/share/caddy/assets
        rewrite * /portal.html
        file_server
    }
    
    # Custom login page at root and /login
    handle /login {
        root * /usr/share/caddy/assets
        rewrite * /login.html
        file_server
    }
    handle / {
        root * /usr/share/caddy/assets
        rewrite * /login.html
        file_server
    }
    
    # AuthCrunch handles OAuth callbacks, logout, whoami etc at /auth/*
    handle /auth/* {
        authenticate with myportal
    }
    handle /oauth2/* {
        authenticate with myportal
    }
    handle /logout {
        authenticate with myportal
    }
    handle /whoami {
        authenticate with myportal
    }
}

# Protected: Code Server
codeh.ingasti.com {
    authorize with mypolicy
    reverse_proxy https://localhost:8443 {
        transport http {
            tls_insecure_skip_verify
        }
    }
}

# Protected: Jenkins
jenkins.ingasti.com {
    authorize with mypolicy
    reverse_proxy localhost:8446
}

# Protected: Jump page
jump.ingasti.com {
    authorize with mypolicy
    root * /usr/share/caddy
    file_server
    try_files {path} /index.html
}

# Mail server - no auth needed
cmh.ingasti.com {
    respond "CMH Mail Server - Certificates managed by Caddy"
}
