apiVersion: v1
kind: Namespace
metadata:
  name: webmail

---
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: snappymail-pvc
  namespace: webmail
spec:
  accessModes:
    - ReadWriteOnce
  resources:
    requests:
      storage: 1Gi
  storageClassName: local-path

---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: snappymail
  namespace: webmail
spec:
  replicas: 1
  selector:
    matchLabels:
      app: snappymail
  template:
    metadata:
      labels:
        app: snappymail
    spec:
      initContainers:
      - name: setup-branding
        image: busybox:latest
        command: ['sh', '-c']
        args:
        - |
          mkdir -p /var/lib/snappymail/custom-themes/Ingasti/images
          
          # Create comprehensive Ingasti theme CSS with BLUE colors
          cat > /var/lib/snappymail/custom-themes/Ingasti/styles.css << 'EOF'
          /* Ingasti SnappyMail Theme - Blue Branding */
          :root {
            --main-bg-color: #fefefe;
            --main-bg-image: none;
            --ingasti-primary: #0066FF;
            --ingasti-secondary: #004E89;
            --ingasti-accent: #0052CC;
          }
          html, body {
            background-color: var(--main-bg-color) !important;
            background-image: none !important;
            color: #1a1a1a !important;
          }
          body { background: var(--main-bg-color) !important; }
          .sp-container, .login-container, #wrapper, .body {
            background-color: var(--main-bg-color) !important;
            background-image: none !important;
          }
          .sp-logo, .login-logo, [class*="logo"] {
            display: block !important;
            width: 140px;
            height: 70px;
            margin: 30px auto;
            background-image: url('./images/ingasti-logo.png') !important;
            background-size: contain;
            background-repeat: no-repeat;
            background-position: center;
          }
          .login-form, .form-group, [class*="form"] {
            background-color: rgba(0, 78, 137, 0.08) !important;
            border-radius: 8px;
            padding: 20px;
            border: 1px solid var(--ingasti-secondary) !important;
          }
          input[type="text"], input[type="email"], input[type="password"], [class*="input"] {
            background-color: #ffffff !important;
            border: 1px solid var(--ingasti-secondary) !important;
            color: #1a1a1a !important;
          }
          input[type="text"]:focus, input[type="email"]:focus, input[type="password"]:focus {
            border-color: var(--ingasti-primary) !important;
            box-shadow: 0 0 0 3px rgba(0, 102, 255, 0.1) !important;
          }
          button, [type="submit"], [class*="btn"] {
            background-color: var(--ingasti-primary) !important;
            color: white !important;
            border: none !important;
            border-radius: 4px;
            font-weight: 600;
          }
          button:hover, [type="submit"]:hover {
            background-color: var(--ingasti-accent) !important;
            box-shadow: 0 2px 8px rgba(0, 102, 255, 0.3) !important;
          }
          .login-title, h1, h2, h3, [class*="title"] {
            color: var(--ingasti-secondary) !important;
            font-weight: 600;
          }
          a, [class*="link"] { color: var(--ingasti-primary) !important; }
          input[type="checkbox"] { accent-color: var(--ingasti-primary) !important; }
          EOF
          
          if [ -f /var/lib/snappymail/logo.png ]; then
              cp /var/lib/snappymail/logo.png /var/lib/snappymail/custom-themes/Ingasti/images/ingasti-logo.png
          fi
          
          echo "Branding setup complete"
        volumeMounts:
        - name: snappymail-data
          mountPath: /var/lib/snappymail
      containers:
      - name: snappymail
        image: ghcr.io/ingasti/snappymail:branding
        imagePullPolicy: Always
        ports:
        - containerPort: 8888
        lifecycle:
          postStart:
            exec:
              command:
              - /bin/sh
              - -c
              - |
                # Find and modify the main HTML file to inject CSS variables at the top of head
                HTML_FILE="/snappymail/snappymail/v/2.38.2/index.php"
                INJECT_CSS='<style>:root{--btn-bg-clr:#0066FF;--btn-clr:#fff;--btn-border-clr:#004E89;--btn-danger-bg-clr:#dc3545;--btn-success-bg-clr:#28a745;--folders-focused-bg-color:#333;--tab-active-bg-clr:#fff;--link-color:#0066FF}</style>'
                
                if [ -f "$HTML_FILE" ]; then
                  # Check if already injected
                  if ! grep -q "btn-bg-clr" "$HTML_FILE"; then
                    # Insert right after <head> tag
                    sed -i "/<head>/a\\        $INJECT_CSS" "$HTML_FILE"
                    echo "CSS variables injected into HTML"
                  fi
                fi
                
                if [ -d /var/lib/snappymail/custom-themes/Ingasti ]; then
                  if [ -f /var/lib/snappymail/custom-themes/Ingasti/styles.css ]; then
                    # Also update Default theme for consistency
                    cat /var/lib/snappymail/custom-themes/Ingasti/styles.css /snappymail/snappymail/v/2.38.2/themes/Default/styles.css > /tmp/merged.css && mv /tmp/merged.css /snappymail/snappymail/v/2.38.2/themes/Default/styles.css
                  fi
                fi
                
                echo "Ingasti branding applied"
        volumeMounts:
        - name: snappymail-data
          mountPath: /var/lib/snappymail
      imagePullSecrets:
      - name: ghcr-credentials
      volumes:
      - name: snappymail-data
        persistentVolumeClaim:
          claimName: snappymail-pvc

---
apiVersion: v1
kind: Service
metadata:
  name: snappymail
  namespace: webmail
spec:
  type: ClusterIP
  selector:
    app: snappymail
  ports:
    - port: 80
      targetPort: 8888
